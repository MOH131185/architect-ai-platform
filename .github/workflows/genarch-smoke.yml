name: Genarch Smoke Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'genarch/**'
      - '.github/workflows/genarch-smoke.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'genarch/**'
      - '.github/workflows/genarch-smoke.yml'
  workflow_dispatch:
    inputs:
      run_full_tests:
        description: 'Run full test suite (includes slow tests)'
        required: false
        default: 'false'
        type: boolean

jobs:
  # Stage 1: Quick validation (lint + imports)
  validate:
    name: Validate Package
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: genarch/requirements.lock

      - name: Install genarch package
        run: |
          cd genarch
          pip install -e ".[dev]"

      - name: Run environment checker
        run: |
          python scripts/genarch/check_env.py
        continue-on-error: true  # genarch not installed in editable mode yet

      - name: Verify imports
        run: |
          python -c "import genarch; print(f'genarch {genarch.__version__}')"
          python -c "from genarch.pipeline import PipelineRunner; print('PipelineRunner OK')"
          python -c "from genarch.validation import AssetValidator, DriftChecker, DriftMetrics; print('Validators OK')"
          python -c "from genarch.phase4 import A1SheetAssembler; print('Phase4 OK')"

      - name: Verify CLI help outputs
        run: |
          cd genarch
          python -m genarch --help
          python -m genarch.pipeline --help
          python -m genarch.validation --help
          python -m genarch.phase4 --help

      - name: Check for syntax errors
        run: |
          cd genarch
          python -m py_compile genarch/__init__.py
          python -m py_compile genarch/__main__.py
          python -m py_compile genarch/pipeline/runner.py
          python -m py_compile genarch/phase4/assemble.py

  # Stage 2: Unit tests
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: genarch/requirements.lock

      - name: Install dependencies
        run: |
          cd genarch
          pip install -e ".[dev]"

      - name: Run unit tests
        run: |
          cd genarch
          python -m pytest tests/ -v --ignore=tests/test_smoke.py -x

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-results
          path: genarch/.pytest_cache/
          retention-days: 7

  # Stage 3: Smoke tests (fast pipeline validation)
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: genarch/requirements.lock

      - name: Install dependencies
        run: |
          cd genarch
          pip install -e ".[all]"

      - name: Run smoke tests
        run: |
          cd genarch
          python tests/test_smoke.py

      - name: Run pytest smoke tests
        run: |
          cd genarch
          python -m pytest tests/test_smoke.py -v \
            -k "test_phase1_outputs_exist or test_plan_json_has_required_fields or test_pipeline_manifest_schema" \
            --timeout=60

  # Stage 4: Full pipeline test (only on manual trigger or main)
  full-pipeline:
    name: Full Pipeline Test
    runs-on: ubuntu-latest
    needs: smoke-tests
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.run_full_tests == 'true' || github.ref == 'refs/heads/main'
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: genarch/requirements.lock

      - name: Install dependencies
        run: |
          cd genarch
          pip install -e ".[all]"

      - name: Run full pipeline test
        run: |
          cd genarch
          python -m genarch.pipeline \
            --prompt "modern minimalist house 180sqm" \
            --out runs/ci_test \
            --seed 42 \
            --skip-phase2 \
            -v

      - name: Validate outputs
        run: |
          cd genarch

          echo "=== Checking Phase 1 outputs ==="
          test -f runs/ci_test/plan.json || { echo "FAIL: plan.json missing"; exit 1; }
          test -f runs/ci_test/plan.dxf || { echo "FAIL: plan.dxf missing"; exit 1; }
          test -f runs/ci_test/run.json || { echo "FAIL: run.json missing"; exit 1; }
          test -f runs/ci_test/constraints.json || { echo "FAIL: constraints.json missing"; exit 1; }
          echo "PASS: Phase 1 outputs OK"

          echo ""
          echo "=== Checking Phase 4 outputs ==="
          test -f runs/ci_test/phase4/A1_sheet.pdf || { echo "FAIL: A1_sheet.pdf missing"; exit 1; }
          test -f runs/ci_test/phase4/sheet_manifest.json || { echo "FAIL: sheet_manifest.json missing"; exit 1; }
          echo "PASS: Phase 4 outputs OK"

          echo ""
          echo "=== Checking pipeline manifest ==="
          test -f runs/ci_test/pipeline_manifest.json || { echo "FAIL: pipeline_manifest.json missing"; exit 1; }
          python -c "import json; m=json.load(open('runs/ci_test/pipeline_manifest.json')); assert m['pipeline']=='genarch'; print('PASS: Manifest valid')"

      - name: Validate A1 PDF size
        run: |
          cd genarch
          python -c "
          from pypdf import PdfReader
          r = PdfReader('runs/ci_test/phase4/A1_sheet.pdf')
          w = float(r.pages[0].mediabox.width) * 25.4 / 72
          h = float(r.pages[0].mediabox.height) * 25.4 / 72
          print(f'PDF size: {w:.1f}mm × {h:.1f}mm')
          assert abs(w - 841) < 2, f'Width {w}mm != 841mm'
          assert abs(h - 594) < 2, f'Height {h}mm != 594mm'
          print('PASS: A1 dimensions correct')
          "

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pipeline-outputs
          path: |
            genarch/runs/ci_test/plan.json
            genarch/runs/ci_test/plan.dxf
            genarch/runs/ci_test/pipeline_manifest.json
            genarch/runs/ci_test/phase4/A1_sheet.pdf
            genarch/runs/ci_test/phase4/sheet_manifest.json
          retention-days: 7

  # Stage 5: Reproducibility test
  reproducibility:
    name: Reproducibility Test
    runs-on: ubuntu-latest
    needs: smoke-tests
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.run_full_tests == 'true'
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: genarch/requirements.lock

      - name: Install dependencies
        run: |
          cd genarch
          pip install -e ".[all]"

      - name: Run reproducibility test
        run: |
          cd genarch
          python -m pytest tests/test_smoke.py::TestReproducibility -v --timeout=120

  # Summary job
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [validate, unit-tests, smoke-tests]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "=== Genarch CI Summary ==="
          echo ""
          echo "Validate: ${{ needs.validate.result }}"
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Smoke Tests: ${{ needs.smoke-tests.result }}"
          echo ""

          if [[ "${{ needs.smoke-tests.result }}" == "success" ]]; then
            echo "✅ All smoke tests passed!"
            exit 0
          else
            echo "❌ Some tests failed"
            exit 1
          fi
