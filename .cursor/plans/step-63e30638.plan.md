<!-- 63e30638-a1a4-4898-bd89-6e3773f088c5 ecb7e662-9a52-4add-92b6-c382bfb2016b -->
# Enforce Site Plan Embed-Only Mode

## Overview

Ensure that site plans are NEVER generated by AI (FLUX) and are ALWAYS displayed as HTML overlays in A1SheetViewer. This prevents visual inconsistency and ensures accurate geographic representation.

## Current State Analysis

**Problems Identified:**

1. `a1SheetPromptGenerator.js` explicitly instructs FLUX to generate a site plan in top-left corner (lines 834-895)
2. `aiModificationService.js` has `addSitePlan` quick toggle that asks AI to draw site plan (line 419-421)
3. `a1SheetValidator.js` expects site plan keywords in prompt, which forces prompt to request AI generation
4. `dnaWorkflowOrchestrator.js` has safeguards but doesn't enforce overlay-only mode strictly
5. Site map capture happens but prompt still asks AI to generate site plan content

**Good Current Behavior:**

- `A1SheetViewer.jsx` already displays site map as HTML overlay (lines 580-598)
- `dnaWorkflowOrchestrator.js` already sets `initImage: null` for site plans (line 939)
- `sitePlanCaptureService.js` captures Google Maps site context

## Files to Modify

### 1. src/services/a1SheetPromptGenerator.js

**Location**: Site plan section in prompt template (lines 834-895)

**Changes:**

- Remove or significantly reduce site plan generation instructions
- Replace detailed site plan drawing instructions with a simple placeholder instruction
- Change from: "Generate a DETAILED ARCHITECTURAL SITE PLAN..."
- Change to: "SITE PLAN PANEL: Reserved for post-processing overlay (Google Maps context). Leave top-left corner as WHITE or LIGHT GRAY background. Label: 'SITE PLAN' with scale 1:1250."
- Update grid layout diagram to indicate site plan is overlay-only
- Add comment explaining that site plan is composited post-generation via HTML overlay

**Specific Sections to Modify:**

- Lines 737-895: Site plan generation instructions (replace with placeholder instructions)
- Line 715: Grid layout comment (add note about overlay)
- Line 727: Critical layout requirements (change to "SITE PLAN: Reserved for HTML overlay")

### 2. src/services/aiModificationService.js

**Location**: Quick toggle handlers (line 419-421)

**Changes:**

- Remove the `addSitePlan` quick toggle logic entirely OR
- Replace with logic that only adds site snapshot to sessionStorage without asking AI to draw
- The quick toggle should trigger site map capture and overlay refresh, NOT AI generation
- Add warning console log if user tries to modify site plan via AI

**Specific Changes:**

```javascript
// BEFORE:
if (quickToggles.addSitePlan) {
  deltaText += '\n\nADD SITE PLAN TO EXISTING A1 SHEET:...';
}

// AFTER:
if (quickToggles.addSitePlan) {
  console.warn('‚ö†Ô∏è Site plan is overlay-only. Refreshing site map capture...');
  // Trigger site map refresh in sessionStorage
  // Do NOT add to deltaText - site plan is never AI-generated
}
```

### 3. src/services/a1SheetValidator.js

**Location**: Site plan validation (lines 316-323)

**Changes:**

- Update site plan validation to accept overlay-only mode
- Check for placeholder keywords instead of detailed generation instructions
- Accept prompts that explicitly mark site plan as "post-processing" or "overlay"
- Add validation to ensure prompt does NOT request AI to draw site plan

**Specific Changes:**

```javascript
// Update validation to accept:
// - "SITE PLAN: Reserved for overlay"
// - "SITE PLAN PANEL: Post-processing"
// - "Leave site plan area blank for overlay"

// Reject if prompt contains:
// - "Generate a detailed site plan"
// - "Draw site boundaries"
// - "AI-generated site plan"
```

### 4. src/services/dnaWorkflowOrchestrator.js

**Location**: Multiple sections handling site maps

**Changes:**

#### 4a. Add strict validation (around line 750-760)

- Add a validator function that throws error if `initImage` is set for site-related calls
- Add assertion: `if (siteMapData?.useAsInitImage) throw new Error('FORBIDDEN: Site plan must never use initImage')`

#### 4b. Update site map mode handling (lines 749-875)

- Remove 'context' mode entirely - only support 'embed' mode
- Rename 'embed' to 'overlay' for clarity
- Add explicit check that ensures site map is ONLY used for overlay, never for AI input

#### 4c. Enhance logging (lines 939-950)

- Add more explicit logging about site plan overlay-only mode
- Log: "üó∫Ô∏è Site plan will be composited as HTML overlay AFTER generation"
- Log: "‚õî Site plan is NOT included in AI generation - prevents visual drift"

#### 4d. Add runtime assertion before image generation call

```javascript
// Before calling togetherAIService.generateArchitecturalImage()
if (imageOptions.initImage && siteMapData) {
  throw new Error('CRITICAL: initImage must be null when site map is present. Site plans use overlay-only mode.');
}
```

### 5. src/services/sitePlanCaptureService.js (optional enhancement)

**Location**: Site map capture logic

**Changes:**

- Add metadata flag: `isOverlayOnly: true`
- Add clear documentation that captured site maps are NEVER used as initImage
- Export a validation function that ensures site maps are used correctly

### 6. src/components/A1SheetViewer.jsx (already correct)

**Location**: Site snapshot overlay (lines 580-598)

**Verify:**

- No changes needed - already implements HTML overlay correctly
- Confirm `siteSnapshot` is loaded from sessionStorage
- Confirm overlay positioning matches expected site plan location (top-left)

## Implementation Order

1. **Start with dnaWorkflowOrchestrator.js** - Add strict validation to prevent initImage for site plans
2. **Update a1SheetPromptGenerator.js** - Replace site plan generation instructions with placeholder
3. **Modify aiModificationService.js** - Remove/disable addSitePlan AI generation
4. **Update a1SheetValidator.js** - Accept overlay-only site plan mode
5. **Enhance sitePlanCaptureService.js** - Add overlay-only metadata
6. **Test end-to-end** - Verify site plan appears as HTML overlay, never AI-generated

## Validation Criteria

After implementation, verify:

1. ‚úÖ Generated A1 sheets have WHITE or LIGHT GRAY placeholder in top-left (not AI-drawn site plan)
2. ‚úÖ A1SheetViewer displays Google Maps overlay in exact same position
3. ‚úÖ Prompt does NOT contain detailed site plan drawing instructions
4. ‚úÖ `initImage` is always `null` when site maps are present
5. ‚úÖ Modification workflow does not request AI to redraw site plans
6. ‚úÖ Downloaded PNG includes the HTML overlay site map (via DOM capture from previous plan)
7. ‚úÖ Console logs confirm "Site plan overlay-only mode" messaging

## Testing Plan

1. Generate new A1 sheet with site data - verify white placeholder in top-left, overlay in viewer
2. Modify existing sheet with "Add Site Plan" toggle - verify no AI generation, only overlay refresh
3. Download PNG - verify site overlay is captured in output
4. Generate sheet without site data - verify graceful handling (no overlay)
5. Check console logs - verify no warnings about initImage or site plan AI generation

## Breaking Changes / Risks

**Minimal Risk:**

- Site plan was already problematic when AI-generated (inconsistent, inaccurate geography)
- HTML overlay provides better accuracy and consistency
- Change is mostly removing problematic code, not adding complexity

**Potential Issues:**

- Validator might flag missing site plan if not updated properly
- Users might expect AI to draw site plan if they see placeholder
- Need clear UI indication that site plan is real map overlay, not AI art

## Documentation Updates

Add to relevant documentation:

- Site plans are ALWAYS real Google Maps overlays, never AI-generated
- Ensures accurate geographic representation and site context
- AI generates placeholder space, overlay is composited in viewer
- Downloaded PNGs include the overlay via DOM capture

### To-dos

- [x] Force site plan embed-only across generate/modify; forbid initImage for site plan
- [x] Unify A1 landscape dimensions in modify path; read from history and enforce
- [x] Compute sun path (solar az/alt) and inject into DNA/prompt; replace placeholders
- [x] Add html-to-image dependency to package.json
- [x] Add strict validation in dnaWorkflowOrchestrator.js to prevent initImage for site plans
- [ ] Replace site plan generation instructions with placeholder in a1SheetPromptGenerator.js