<!-- 0630c90d-c918-4a08-a6e5-02dd5883630d 3507173a-8b21-4804-b6d7-6140efb5796e -->
# A1 Modify Consistency + Site Map Parity + Single Generate Panel (Keep “Generate” as base)

## Why modifications drift

- High img2img strength (0.85) + dimension/orientation mismatch vs baseline causes heavy reinterpretation (SSIM ~0.10–0.17).
- Oversized lock prompt (~60k chars) likely truncated and diluted.

## What we’ll change

- Lock modify to baseline width/height/model and reuse the original seed.
- Use low img2img strength 0.18 (strict retry 0.12) to preserve the base.
- Replace huge lock prompt with a compact lock (<8k chars) focused on deltas and forbidding layout/color/font changes.
- Strict retry if SSIM < 0.92 (same seed/dims/model, lower strength).
- Site Map Parity: persist the exact Google snapshot and composite it into the A1 site panel for pixel-exact parity.
- UI: Keep the “Generate Modified A1 Sheet” panel as the single, canonical panel; fold other modify UIs into it.

## Targeted edits

- src/services/designHistoryService.js
- Persist/expose base sheet metadata: width, height, model, seed, a1LayoutKey.
- Persist `siteSnapshot`: { dataUrl/hash, center {lat,lng}, zoom, mapType, size, polygon: coords+style }.
- src/services/aiModificationService.js
- Read baseline dims/model/seed and `siteSnapshot` from history.
- Pass `initImageUrl` = baseline A1 sheet; set `imageStrength = 0.18` (configurable).
- Build concise lock with `withConsistencyLockCompact(delta, dna, layoutKey)`.
- If SSIM < 0.92, retry with `imageStrength = 0.12`; keep dims/seed/model.
- After output, composite the same `siteSnapshot` back into the “site map” panel bbox before saving.
- src/services/a1SheetPromptGenerator.js
- Add `withConsistencyLockCompact()` (<8k chars) with immutable elements list and focused deltas.
- src/services/togetherAIService.js
- When `initImageUrl` exists, never auto-rotate; honor explicit width/height from caller.
- Treat dims as source of truth; fix portrait/landscape label mismatch.
- src/services/siteMapSnapshotService.js
- Capture snapshot (with polygon overlay) matching UI center/zoom/mapType/size; return `dataUrl`, `sha256`, metadata.
- src/services/architecturalSheetService.js (or util)
- Resolve pixel bbox for the site map panel by `a1LayoutKey` and dims.
- `compositeSiteSnapshot(baseSheet, siteSnapshot, bbox)` (letterbox if aspect differs; add attribution if required).
- src/components/GenerateModifiedA1Panel.jsx (new or rename existing)
- Make this the only panel visible; move all controls here: quick toggles, custom delta prompt, Strict Lock (default ON), map provenance (center/zoom/type, Re-capture), version history, and the primary CTA.
- Remove/hide `AIModifyPanel.jsx` and `ModifyDesignDrawer.js` from the UI routing; keep code if needed behind a flag.

## Key defaults

- img2img strength: 0.18; strict retry: 0.12.
- Consistency thresholds: SSIM ≥ 0.92; pHash ≤ 8 (advisory).
- Site map parity: composited snapshot identical to the UI snapshot.

## Validation

- node test-a1-modify-consistency.js → expect SSIM ≥ 0.92 on 1st/2nd try.
- node test-site-snapshot-consistency.js → site panel equals snapshot (SSIM ≈ 1.0).
- Manual: small deltas; verify sheet remains visually identical, site map matches exactly.

## Rollback

- Gate strict lock and site-map compositing under `enhancedConsistencyChecks`. Toggle to revert.

### To-dos

- [ ] Persist base A1 width/height/model/seed in design history
- [ ] Lock modify generation to baseline width/height and model
- [ ] Use low img2img strength (0.18) with strict retry at 0.12
- [ ] Implement withConsistencyLockCompact to cap prompt size <8k
- [ ] Honor explicit dims in together service; fix orientation mismatch
- [ ] Capture and persist Google map snapshot + metadata + hash
- [ ] Include site polygon overlay on the snapshot image
- [ ] Composite site snapshot into base A1 site panel bbox
- [ ] Composite site snapshot after modify before saving version
- [ ] Add test to assert site panel equals snapshot (pixel compare)
- [ ] Make Generate Modified A1 Sheet the only panel; fold other UIs
- [ ] Add Strict Lock toggle and map provenance to the Generate panel
- [ ] Update modify-consistency test expects SSIM ≥ 0.92