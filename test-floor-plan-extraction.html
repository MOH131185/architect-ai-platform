<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Floor Plan Extraction Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Floor Plan Extraction Test</h1>
        <p>This test verifies that the floor plan extraction logic is working correctly after the fix.</p>

        <button onclick="runTest()">Run Extraction Test</button>

        <div id="results"></div>
    </div>

    <script>
        function runTest() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<h2>Test Results:</h2>';

            // Simulate the structure returned by replicateService.generateMultiLevelFloorPlans
            const mockReplicateResult = {
                success: true,
                floorPlans: {
                    ground: {
                        images: ['https://placehold.co/1024x1024/2C3E50/FFFFFF?text=Ground+Floor+Plan'],
                        success: true
                    },
                    upper: {
                        images: ['https://placehold.co/1024x1024/34495E/FFFFFF?text=Upper+Floor+Plan'],
                        success: true
                    },
                    roof: {
                        images: ['https://placehold.co/1024x1024/1A252F/FFFFFF?text=Roof+Plan'],
                        success: true
                    }
                },
                floorCount: 2,
                projectSeed: 123456
            };

            // Test different aiResult structures
            const testCases = [
                {
                    name: "Direct floorPlans structure (FIXED)",
                    aiResult: { floorPlans: mockReplicateResult.floorPlans },
                    expectedKeys: ['ground', 'upper', 'roof']
                },
                {
                    name: "Nested floorPlans.floorPlans structure (OLD)",
                    aiResult: { floorPlans: { floorPlans: mockReplicateResult.floorPlans } },
                    expectedKeys: ['ground', 'upper', 'roof']
                },
                {
                    name: "Results structure",
                    aiResult: { results: { floorPlans: { floorPlans: mockReplicateResult.floorPlans } } },
                    expectedKeys: ['ground', 'upper', 'roof']
                }
            ];

            testCases.forEach((testCase, index) => {
                const result = extractFloorPlanImages(testCase.aiResult);
                const success = Object.keys(result).length > 0 && !result.ground.includes('Loading');

                const div = document.createElement('div');
                div.className = `result ${success ? 'success' : 'error'}`;
                div.innerHTML = `
                    <h3>Test ${index + 1}: ${testCase.name}</h3>
                    <p><strong>Status:</strong> ${success ? '‚úÖ PASSED' : '‚ùå FAILED'}</p>
                    <p><strong>Expected keys:</strong> ${testCase.expectedKeys.join(', ')}</p>
                    <p><strong>Extracted keys:</strong> ${Object.keys(result).join(', ') || 'None'}</p>
                    <details>
                        <summary>View extracted data</summary>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    </details>
                `;
                resultsDiv.appendChild(div);
            });
        }

        // The extraction function (matching the fixed version in ArchitectAIEnhanced.js)
        function extractFloorPlanImages(aiResult) {
            const floorPlans = {};

            console.log('üìã Extracting floor plans from aiResult:', {
                hasFloorPlans: !!aiResult.floorPlans,
                hasDirectFloorPlansGround: !!aiResult.floorPlans?.ground,
                hasFloorPlansFloorPlansGround: !!aiResult.floorPlans?.floorPlans?.ground,
            });

            // Try integrated design results structure first
            if (aiResult.results?.floorPlans?.floorPlans?.ground?.images) {
                const plans = aiResult.results.floorPlans.floorPlans;
                if (plans.ground?.images) floorPlans.ground = plans.ground.images[0];
                if (plans.upper?.images) floorPlans.upper = plans.upper.images[0];
                if (plans.roof?.images) floorPlans.roof = plans.roof.images[0];
                console.log('‚úÖ Extracted from integrated results');
            }
            // Try floorPlans.floorPlans (old structure)
            else if (aiResult.floorPlans?.floorPlans?.ground?.images) {
                const plans = aiResult.floorPlans.floorPlans;
                if (plans.ground?.images) floorPlans.ground = plans.ground.images[0];
                if (plans.upper?.images) floorPlans.upper = plans.upper.images[0];
                if (plans.roof?.images) floorPlans.roof = plans.roof.images[0];
                console.log('‚úÖ Extracted from floorPlans.floorPlans');
            }
            // FIXED: Try direct floorPlans structure (correct structure from replicateService)
            else if (aiResult.floorPlans?.ground) {
                const plans = aiResult.floorPlans;
                if (plans.ground?.images && plans.ground.images.length > 0) {
                    floorPlans.ground = plans.ground.images[0];
                    console.log('‚úÖ Extracted ground floor plan');
                }
                if (plans.upper?.images && plans.upper.images.length > 0) {
                    floorPlans.upper = plans.upper.images[0];
                    console.log('‚úÖ Extracted upper floor plan');
                }
                if (plans.roof?.images && plans.roof.images.length > 0) {
                    floorPlans.roof = plans.roof.images[0];
                    console.log('‚úÖ Extracted roof plan');
                }
                console.log('‚úÖ Extracted from direct floorPlans structure');
            }

            // Fallback placeholder
            if (!floorPlans.ground) {
                floorPlans.ground = 'https://placehold.co/1024x1024/2C3E50/FFFFFF?text=Floor+Plan+Loading';
                console.log('‚ö†Ô∏è No floor plan found, using placeholder');
            }

            return floorPlans;
        }
    </script>
</body>
</html>