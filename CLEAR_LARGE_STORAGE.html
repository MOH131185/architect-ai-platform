<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clear Large Storage - Architect AI</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2563eb;
            margin-top: 0;
        }
        .info {
            background: #dbeafe;
            border-left: 4px solid #2563eb;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .success {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .error {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px 10px 0;
        }
        button:hover {
            background: #1d4ed8;
        }
        button.danger {
            background: #ef4444;
        }
        button.danger:hover {
            background: #dc2626;
        }
        pre {
            background: #f9fafb;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 14px;
        }
        .stat {
            display: inline-block;
            margin: 10px 20px 10px 0;
        }
        .stat strong {
            color: #2563eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßπ Clear Large Storage Data</h1>

        <div class="info">
            <strong>‚ÑπÔ∏è Purpose:</strong> This tool removes oversized design history that's causing "QuotaExceededError".
            Your design history is likely storing large base64-encoded images (10-20MB) that exceed browser storage limits.
        </div>

        <div class="warning">
            <strong>‚ö†Ô∏è Warning:</strong> This will clear your design history. The actual A1 sheets displayed on screen won't be affected,
            but you won't be able to use "Modify A1 Sheet" on old designs after clearing.
        </div>

        <h2>Current Storage Status</h2>
        <div id="status">Checking...</div>

        <h2>Actions</h2>
        <button onclick="checkStorage()">üîç Check Storage</button>
        <button onclick="clearDesignHistory()" class="danger">üóëÔ∏è Clear Design History</button>
        <button onclick="clearAllStorage()" class="danger">‚ö†Ô∏è Clear ALL Storage</button>

        <h2>Results</h2>
        <div id="results"></div>
    </div>

    <script>
        // Check storage on load
        window.addEventListener('load', checkStorage);

        function checkStorage() {
            const results = document.getElementById('results');
            const statusDiv = document.getElementById('status');

            try {
                // Get all localStorage keys
                const allKeys = Object.keys(localStorage);
                const archiKeys = allKeys.filter(k => k.startsWith('archiAI_'));

                let totalSize = 0;
                let largeItems = [];

                archiKeys.forEach(key => {
                    const value = localStorage.getItem(key);
                    if (value) {
                        const sizeKB = value.length / 1024;
                        totalSize += sizeKB;

                        if (sizeKB > 1000) { // > 1MB
                            largeItems.push({
                                key: key,
                                sizeKB: sizeKB.toFixed(2),
                                sizeMB: (sizeKB / 1024).toFixed(2)
                            });
                        }
                    }
                });

                const totalSizeMB = (totalSize / 1024).toFixed(2);
                const estimatedQuotaMB = 5; // Conservative estimate
                const usagePercent = ((totalSize / 1024) / estimatedQuotaMB * 100).toFixed(1);

                // Status summary
                let statusHTML = `
                    <div class="stat"><strong>Total Items:</strong> ${archiKeys.length}</div>
                    <div class="stat"><strong>Total Size:</strong> ${totalSizeMB} MB</div>
                    <div class="stat"><strong>Estimated Usage:</strong> ${usagePercent}%</div>
                `;

                if (parseFloat(totalSizeMB) > 5) {
                    statusHTML = `<div class="error">${statusHTML}</div>`;
                } else if (parseFloat(usagePercent) > 80) {
                    statusHTML = `<div class="warning">${statusHTML}</div>`;
                } else {
                    statusHTML = `<div class="info">${statusHTML}</div>`;
                }

                statusDiv.innerHTML = statusHTML;

                // Detailed results
                let html = '<div class="info">';
                html += `<strong>‚úÖ Storage check complete</strong><br>`;
                html += `Found ${archiKeys.length} items using ${totalSizeMB} MB`;
                html += '</div>';

                if (largeItems.length > 0) {
                    html += '<div class="error">';
                    html += `<strong>‚ö†Ô∏è Found ${largeItems.length} oversized item(s):</strong><br><br>`;
                    largeItems.forEach(item => {
                        html += `üì¶ <strong>${item.key}</strong>: ${item.sizeMB} MB (${item.sizeKB} KB)<br>`;
                    });
                    html += '<br><strong>These items are causing QuotaExceededError!</strong>';
                    html += '</div>';
                }

                results.innerHTML = html;

            } catch (error) {
                results.innerHTML = `<div class="error">‚ùå Error checking storage: ${error.message}</div>`;
            }
        }

        function clearDesignHistory() {
            if (!confirm('‚ö†Ô∏è Clear design history?\n\nThis will remove all stored designs but won\'t affect the A1 sheet currently displayed.')) {
                return;
            }

            const results = document.getElementById('results');

            try {
                const historyKey = 'archiAI_design_history';
                const oldValue = localStorage.getItem(historyKey);
                const oldSizeMB = oldValue ? (oldValue.length / 1024 / 1024).toFixed(2) : 0;

                localStorage.removeItem(historyKey);

                results.innerHTML = `
                    <div class="success">
                        <strong>‚úÖ Design history cleared!</strong><br><br>
                        Freed ${oldSizeMB} MB of storage<br>
                        You can now generate new designs without quota errors.
                    </div>
                `;

                // Refresh status
                setTimeout(checkStorage, 500);

            } catch (error) {
                results.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        function clearAllStorage() {
            if (!confirm('‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è Clear ALL storage?\n\nThis will remove EVERYTHING including:\n- Design history\n- Portfolio cache\n- Location data\n- All preferences\n\nAre you sure?')) {
                return;
            }

            const results = document.getElementById('results');

            try {
                const allKeys = Object.keys(localStorage);
                const archiKeys = allKeys.filter(k => k.startsWith('archiAI_'));

                let totalFreed = 0;
                archiKeys.forEach(key => {
                    const value = localStorage.getItem(key);
                    if (value) {
                        totalFreed += value.length;
                    }
                    localStorage.removeItem(key);
                });

                const freedMB = (totalFreed / 1024 / 1024).toFixed(2);

                results.innerHTML = `
                    <div class="success">
                        <strong>‚úÖ All storage cleared!</strong><br><br>
                        Removed ${archiKeys.length} items<br>
                        Freed ${freedMB} MB of storage<br>
                        You now have a clean slate.
                    </div>
                `;

                // Refresh status
                setTimeout(checkStorage, 500);

            } catch (error) {
                results.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
